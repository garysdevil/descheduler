# 开发
## 二次开发 
### 测试运行
CGO_ENABLED=0 go run  sigs.k8s.io/descheduler/cmd/descheduler --policy-config-file examples/develop.yaml --kubeconfig /tmp/admin.conf
CGO_ENABLED=0 go run  sigs.k8s.io/descheduler/cmd/descheduler --policy-config-file examples/develop.yaml --kubeconfig /tmp/admin.conf -v 3
### 添加新的依赖包
1. 修改go.mod
2. go mod vendor
### 添加新的struct
1. 在以下两个文件内都添加相同的struct
./pkg/api/types.go
./pkg/api/v1alpha1/types.go
2. 执行 make gen
    1. 生成的内部和外部类型之间转换的函数代码会被放置在${GOPATH}/src/sigs.k8s.io/descheduler目录下
    2. 注意对比生成新的代码与旧的差异
    3. pkg/api/v1alpha1/zz_generated.conversion.go
    ```go
    // Convert_componentconfig_DeschedulerConfiguration_To_v1alpha1_DeschedulerConfiguration is an autogenerated conversion function.
    func Convert_componentconfig_DeschedulerConfiguration_To_v1alpha1_DeschedulerConfiguration(in *componentconfig.DeschedulerConfiguration, out *DeschedulerConfiguration, s conversion.Scope) error {
        return autoConvert_componentconfig_DeschedulerConfiguration_To_v1alpha1_DeschedulerConfiguration(in, out, s)
    }
    ```
## 参考文件
0. origin
https://github.com/kubernetes-sigs/descheduler
https://blog.csdn.net/xiashanrenlaozhang/article/details/92413091
1. KEP
https://docs.google.com/document/d/1ffBpzhqELmhqJxdGMzYzIOoigxn3J0zlP1_nie34f9s/edit#heading=h.defm38wxvjp1
https://github.com/kubernetes-sigs/scheduler-plugins/tree/master/kep/61-Trimaran-real-load-aware-scheduling
2. metrics 
https://stackoverflow.com/questions/52029656/how-to-retrieve-kubernetes-metrics-via-client-go-and-golang
https://github.com/kubernetes/metrics
3. kubernetes
https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#watch-node-v1-core  
https://godoc.org/k8s.io/apimachinery/pkg/api/resource#pkg-index

# 使用
## 生产环境使用
```bash
cd kubernetes
# 创建rbac 和 配置文件configmap
kubectl create -f base/rbac.yaml
kubectl create -f base/configmap-new.yaml
# 创建 cronjob
kubectl create -f cronjob/cronjob.yaml
```